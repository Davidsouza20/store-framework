"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const ora_1 = tslib_1.__importDefault(require("ora"));
const chalk_1 = tslib_1.__importDefault(require("chalk"));
const Lighthouse_1 = require("../client/Lighthouse");
const vtex_1 = require("vtex");
const TableGenerator_1 = require("./TableGenerator");
async function isProdutionWorkspace(account, workspace) {
    const workspaces = vtex_1.createWorkspacesClient();
    const meta = await workspaces.get(account, workspace);
    return meta.production;
}
exports.default = async (url, option) => {
    const { workspace, account } = vtex_1.SessionManager.getSingleton();
    if (await isProdutionWorkspace(account, workspace)) {
        vtex_1.logger.error(`You cannot run lighthouse audits on production workspaces.`);
        return;
    }
    const spinner = ora_1.default(`Running Lighthouse on url: ${chalk_1.default.blue(url)}`).start();
    try {
        const lighthouse = Lighthouse_1.Lighthouse.createClient();
        const report = await lighthouse.runAudit(url);
        spinner.stop();
        if (option.json) {
            console.log(JSON.stringify(report, null, 1));
        }
        else {
            const table = new TableGenerator_1.TableGenerator();
            table.addReportScores(report);
            table.show();
        }
    }
    catch (error) {
        spinner.stop();
        vtex_1.ErrorReport.createAndMaybeRegisterOnTelemetry({ originalError: error });
        vtex_1.logger.error(error);
    }
};
